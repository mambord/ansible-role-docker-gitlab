version: "3"

services:
  gitlab:
    image: 'gitlab/gitlab-ce:latest'
    container_name: gitlab
    hostname: {{ docker_gitlab_url }}
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url "https://{{ docker_gitlab_url }}"
        nginx['listen_port'] = 80
        nginx['listen_https'] = false
        nginx['http2_enabled'] = false
        nginx['proxy_set_headers'] = {
          "Host" => "$$http_host",
          "X-Real-IP" => "$$remote_addr",
          "X-Forwarded-For" => "$$proxy_add_x_forwarded_for",
          "X-Forwarded-Proto" => "https",
          "X-Forwarded-Ssl" => "on"
        }
        gitlab_rails['smtp_enable'] = {{ docker_gitlab_conf_smtp_enable }}
{% if docker_gitlab_conf_smtp_enable == 'true' %}
        gitlab_rails['smtp_address'] = "{{ docker_gitlab_conf_smtp_address }}"
        gitlab_rails['smtp_port'] = {{ docker_gitlab_conf_smtp_port }}
        gitlab_rails['smtp_user_name'] = "{{ docker_gitlab_conf_smtp_user_name }}"
        gitlab_rails['smtp_password'] = "{{ docker_gitlab_conf_smtp_password }}"
        gitlab_rails['smtp_domain'] = "{{ docker_gitlab_conf_smtp_domain }}"
        gitlab_rails['smtp_authentication'] = "{{ docker_gitlab_conf_smtp_authentication }}"
        gitlab_rails['smtp_enable_starttls_auto'] = {{ docker_gitlab_conf_smtp_enable_starttls_auto }}
        gitlab_rails['smtp_tls'] = {{ docker_gitlab_conf_smtp_tls }}
        gitlab_rails['gitlab_email_from'] = "{{ docker_gitlab_conf_smtp_email_from }}"
{% endif %}
    networks:
      - {{ docker_gitlab_traefik_network }}
    ports:
      - '{{ docker_gitlab_host_ssh_port }}:22'
    volumes:
      - "{{ docker_gitlab_base_dir }}/config:/etc/gitlab"
      - "{{ docker_gitlab_base_dir }}/logs:/var/log/gitlab"
      - "{{ docker_gitlab_base_dir }}/data:/var/opt/gitlab"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gitlab-http.entrypoints=http"
      - "traefik.http.routers.gitlab-http.rule=Host(`{{ docker_gitlab_url }}`)"
      - "traefik.http.routers.gitlab-http.middlewares=https-redirect@file"
      - "traefik.http.services.gitlab-http.loadbalancer.server.port=80"
      - "traefik.http.routers.gitlab-https.entrypoints=https"
      - "traefik.http.routers.gitlab-https.rule=Host(`{{ docker_gitlab_url }}`)"
      - "traefik.http.routers.gitlab-https.tls=true"
      - "traefik.http.routers.gitlab-https.tls.certresolver=letsencrypt"
networks:
  {{ docker_gitlab_traefik_network }}:
    external: true
